<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Numerical Skills Assessment & Dyscalculia Profiler</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Error Handler for Debugging -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            console.error("Error: " + msg + "\nLine: " + line);
        };
    </script>

    <!-- API Configuration -->
    <script>
        window.API_BASE_URL = 'http://localhost:5000/api';
    </script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --academic-blue: #2c3e50;
            --academic-gold: #c0392b;
            --bg-sidebar: #f8f9fa;
            --text-primary: #2d3748;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: var(--text-primary);
        }
        h1, h2, h3, h4 {
            font-family: 'Merriweather', serif;
        }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .nav-item.active { background-color: #e2e8f0; border-right: 4px solid #3b82f6; font-weight: 600; }
        .nav-item.active.theme-green { background-color: #f0fdf4; border-right: 4px solid #16a34a; color: #15803d; }
        .nav-item.active.theme-purple { background-color: #faf5ff; border-right: 4px solid #9333ea; color: #7e22ce; }
        .nav-item.active.theme-cyan { background-color: #ecfeff; border-right: 4px solid #06b6d4; color: #0e7490; }
        .nav-item.active.theme-amber { background-color: #fffbeb; border-right: 4px solid #d97706; color: #b45309; }

        #drawingCanvas { border: 2px dashed #cbd5e1; background-color: white; cursor: crosshair; touch-action: none; }
        
        /* Card Flip Animation */
        .memory-card { perspective: 1000px; }
        .memory-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .memory-card.flipped .memory-inner { transform: rotateY(180deg); }
        .memory-front, .memory-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .memory-front { background-color: #3b82f6; color: white; }
        .memory-back { background-color: white; color: #1e293b; transform: rotateY(180deg); border: 2px solid #e2e8f0; font-weight: bold; font-size: 1.25rem; }
        .memory-card.matched .memory-back { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }

        /* Bubble Animation */
        @keyframes floatUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(-100vh); opacity: 1; } }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- Sidebar (Hidden initially) -->
    <aside id="sidebar" class="sidebar fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-200 transform -translate-x-full flex flex-col hidden">
        <div class="p-6 border-b border-gray-100">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <i class="fa-solid fa-brain text-blue-600"></i>
                <span>NumSkills<span class="text-blue-600">Pro</span></span>
            </h1>
            <p class="text-xs text-slate-500 mt-1">Dyscalculia Assessment Tool</p>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-4">
            <ul class="space-y-1">
                <li><button onclick="app.navigateTo('dashboard')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 text-slate-700 flex items-center gap-3 active" id="nav-dashboard"><i class="fa-solid fa-chart-line w-5"></i> Dashboard</button></li>
                <li><button onclick="app.navigateTo('checklist')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 text-slate-700 flex items-center gap-3" id="nav-checklist"><i class="fa-solid fa-list-check w-5"></i> Symptom Checklist</button></li>
                
                <li class="px-6 pt-4 pb-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">Skill Modules</li>
                <li><button onclick="app.navigateTo('module-magnitude')" class="nav-item w-full text-left px-6 py-2 hover:bg-slate-50 text-slate-600 flex items-center gap-3" id="nav-module-magnitude"><i class="fa-solid fa-scale-unbalanced w-5"></i> Magnitude</button></li>
                <li><button onclick="app.navigateTo('module-estimation')" class="nav-item w-full text-left px-6 py-2 hover:bg-slate-50 text-slate-600 flex items-center gap-3" id="nav-module-estimation"><i class="fa-solid fa-calculator w-5"></i> Estimation</button></li>
                <li><button onclick="app.navigateTo('module-facts')" class="nav-item w-full text-left px-6 py-2 hover:bg-slate-50 text-slate-600 flex items-center gap-3" id="nav-module-facts"><i class="fa-solid fa-shapes w-5"></i> Fact Retrieval</button></li>
                <li><button onclick="app.navigateTo('module-sequencing')" class="nav-item w-full text-left px-6 py-2 hover:bg-slate-50 text-slate-600 flex items-center gap-3" id="nav-module-sequencing"><i class="fa-solid fa-arrow-down-1-9 w-5"></i> Sequencing</button></li>
                <li><button onclick="app.navigateTo('module-spatial')" class="nav-item w-full text-left px-6 py-2 hover:bg-slate-50 text-slate-600 flex items-center gap-3" id="nav-module-spatial"><i class="fa-solid fa-cube w-5"></i> Spatial Rsng.</button></li>
                <li><button onclick="app.navigateTo('module-memory')" class="nav-item w-full text-left px-6 py-2 hover:bg-slate-50 text-slate-600 flex items-center gap-3" id="nav-module-memory"><i class="fa-solid fa-memory w-5"></i> Working Memory</button></li>
                <li class="mt-2"><button onclick="app.navigateTo('handwriting')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 text-slate-700 flex items-center gap-3" id="nav-handwriting"><i class="fa-solid fa-pen-fancy w-5"></i> Handwriting Task</button></li>
                <li class="mt-1"><button onclick="app.navigateTo('module-consolidated')" class="nav-item w-full text-left px-6 py-3 hover:bg-green-50 text-slate-700 flex items-center gap-3" id="nav-module-consolidated"><i class="fa-solid fa-clipboard-check w-5 text-green-600"></i> Consolidated Exam</button></li>

                <!-- Gamified Zone -->
                <li class="mt-4 border-t border-gray-100 pt-2">
                    <div class="px-6 py-2 text-xs font-semibold text-slate-400 uppercase tracking-wider">Gamified Zone</div>
                    <button onclick="app.navigateTo('space-game')" class="nav-item w-full text-left px-6 py-2 hover:bg-purple-50 text-slate-700 flex items-center gap-3" id="nav-space-game"><i class="fa-solid fa-rocket w-5 text-purple-600"></i> Neon Runner</button>
                    <button onclick="app.navigateTo('aqua-game')" class="nav-item w-full text-left px-6 py-2 hover:bg-cyan-50 text-slate-700 flex items-center gap-3" id="nav-aqua-game"><i class="fa-solid fa-water w-5 text-cyan-600"></i> Aqua Math Pop</button>
                    <button onclick="app.navigateTo('fact-match')" class="nav-item w-full text-left px-6 py-2 hover:bg-amber-50 text-slate-700 flex items-center gap-3" id="nav-fact-match"><i class="fa-solid fa-puzzle-piece w-5 text-amber-600"></i> Fact Match</button>
                </li>

                <li class="mt-2 border-t border-gray-100 pt-2">
                    <button onclick="app.navigateTo('report')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 text-slate-700 flex items-center gap-3" id="nav-report"><i class="fa-solid fa-file-pdf w-5"></i> Final Report</button>
                </li>
            </ul>
        </nav>
        <div class="p-4 border-t border-gray-200 text-xs text-slate-500">
            <div id="auth-status" class="flex items-center gap-2 mb-2">
                <div class="w-2 h-2 rounded-full bg-gray-300" id="auth-indicator"></div>
                <span id="auth-text">Checking Auth...</span>
            </div>
            <span id="user-id-display" class="font-mono text-[10px] break-all"></span>
            <button onclick="app.signOutUser()" class="w-full mt-2 bg-red-50 text-red-600 text-xs py-1.5 rounded hover:bg-red-100 transition"><i class="fa-solid fa-sign-out-alt"></i> Sign Out</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full w-full transition-all duration-300 md:ml-0" id="main-container">
        
        <!-- MAIN HEADER (Hidden on Auth Page) -->
        <header id="main-header" class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-4 md:px-8 shadow-sm z-40 hidden">
            <button id="sidebar-toggle" class="text-slate-600 p-2"><i class="fa-solid fa-bars text-xl"></i></button>
            <h2 id="page-title" class="text-lg md:text-xl font-bold text-slate-800">Dashboard</h2>
            <div class="flex items-center gap-2 md:gap-4">
                <button onclick="app.exportData()" class="text-sm bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded-md hover:bg-slate-50 transition-colors flex items-center gap-2" title="Export Backup">
                    <i class="fa-solid fa-download"></i> <span class="hidden sm:inline">Export</span>
                </button>
                <label class="text-sm bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded-md hover:bg-slate-50 transition-colors flex items-center gap-2 cursor-pointer" title="Import Backup">
                    <i class="fa-solid fa-upload"></i> <span class="hidden sm:inline">Import</span>
                    <input type="file" class="hidden" onchange="app.importData(this)" accept=".json">
                </label>
                <div class="h-6 w-px bg-slate-300 mx-1"></div>
                <button onclick="app.saveData(true)" class="text-sm bg-blue-50 text-blue-600 px-3 py-1.5 rounded-md hover:bg-blue-100 transition-colors flex items-center gap-2">
                    <i class="fa-solid fa-cloud-arrow-up"></i> <span class="hidden sm:inline">Save</span>
                </button>
            </div>
        </header>

        <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50 relative">
            <!-- Toast -->
            <div id="notification" class="fixed top-20 right-4 bg-white border-l-4 border-blue-500 text-slate-700 px-4 py-3 shadow-lg rounded transform translate-x-full transition-transform duration-300 z-50 max-w-xs"><p id="notification-msg" class="text-sm font-medium"></p></div>
            <!-- Loader -->
            <div id="loading-overlay" class="absolute inset-0 bg-white/80 z-40 flex items-center justify-center hidden"><div class="flex flex-col items-center"><div class="loader mb-3"></div><p id="loading-text" class="text-slate-600 text-sm font-medium">Loading...</p></div></div>

            <!-- VIEW: LOADING (Initial state before auth confirmation) -->
            <div id="view-loading" class="view-section flex items-center justify-center h-full -mt-16">
                <div class="text-center bg-white p-8 rounded-xl shadow-lg border border-slate-200 w-full max-w-md">
                    <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4"><i class="fa-solid fa-brain"></i></div>
                    <h1 class="text-2xl font-bold text-slate-800">NumSkills<span class="text-blue-600">Pro</span></h1>
                    <p class="text-slate-500 text-sm mb-6">Securing Session...</p>
                    <div class="loader mx-auto mb-4"></div>
                    <p id="auth-flow-status" class="text-xs text-slate-500">Connecting to Cloud Services.</p>
                </div>
            </div>

            <!-- VIEW: PROFILE SETUP (Acts as required login page) -->
            <div id="view-profile-setup" class="view-section flex items-center justify-center h-full -mt-16 hidden">
                <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200 w-full max-w-md">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Welcome! Enter Candidate Profile</h2>
                        <p class="text-slate-500 text-sm">This is the required first step to start saving assessment data.</p>
                    </div>
                    <form id="initial-registration-form" onsubmit="app.handleRegistration(event, true)" class="space-y-4">
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Child's Name (Required)</label><input type="text" id="child-name-init" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" required></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Child's Age (4-18)</label><input type="number" id="child-age-init" min="4" max="18" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" required value="8"></div>
                        <div><label class="block text-sm font-medium text-slate-700 mb-1">Parent/Guardian Name</label><input type="text" id="parent-name-init" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" required></div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition shadow-sm font-medium">Start Assessment</button>
                    </form>
                </div>
            </div>


            <!-- DASHBOARD -->
            <div id="view-dashboard" class="view-section space-y-6 max-w-4xl mx-auto hidden">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold mb-4 text-slate-800">Candidate Profile</h3>
                    <form id="registration-form" onsubmit="app.handleRegistration(event)" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium text-slate-700 mb-1">Child's Name</label><input type="text" id="child-name" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" required></div>
                            <div><label class="block text-sm font-medium text-slate-700 mb-1">Child's Age</label><input type="number" id="child-age" min="4" max="18" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" required></div>
                            <div><label class="block text-sm font-medium text-slate-700 mb-1">Parent/Guardian Name</label><input type="text" id="parent-name" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" required></div>
                        </div>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition shadow-sm">Update Profile</button>
                    </form>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200"><div class="text-slate-500 text-sm mb-1">Completion</div><div class="text-2xl font-bold text-slate-800" id="progress-percent">0%</div><div class="w-full bg-gray-200 rounded-full h-2.5 mt-2"><div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200"><div class="text-slate-500 text-sm mb-1">Game Scores</div><div class="flex gap-2 text-xs mt-2"><span class="px-2 py-1 bg-purple-100 text-purple-700 rounded">Neon: <span id="dash-neon">0</span></span><span class="px-2 py-1 bg-cyan-100 text-cyan-700 rounded">Aqua: <span id="dash-aqua">0</span></span></div></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200"><div class="text-slate-500 text-sm mb-1">Modules</div><div class="text-2xl font-bold text-slate-800" id="dashboard-modules-count">0/8</div></div>
                </div>
            </div>

            <!-- CHECKLIST -->
            <div id="view-checklist" class="view-section hidden max-w-3xl mx-auto">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold mb-6 text-slate-800">Behavioral Symptom Checklist</h3>
                    <form id="checklist-form" onsubmit="app.submitChecklist(event)"><div id="checklist-container" class="space-y-6"></div><div class="mt-8 pt-4 border-t border-gray-100 flex justify-end"><button type="submit" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 shadow-sm font-medium">Submit Checklist</button></div></form>
                </div>
            </div>

            <!-- MODULES -->
            <div id="view-game" class="view-section hidden max-w-3xl mx-auto">
                <div id="game-container" class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 min-h-[400px] flex flex-col transition-colors duration-300">
                    <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-100"><h3 id="game-title" class="text-lg font-semibold text-slate-800">Module</h3><span id="game-progress" class="text-sm text-slate-500 font-mono">Q: 1/5</span></div>
                    <div id="game-content" class="flex-1"><div id="question-text" class="text-xl font-medium text-center text-slate-800 mb-8 mt-4">Loading...</div><div id="answers-area" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-lg mx-auto"></div></div>
                    <div id="game-feedback" class="mt-6 text-center h-8 text-sm font-bold"></div>
                    <div class="mt-6 flex justify-between items-center"><button onclick="app.regenerateQuestions()" class="text-xs text-slate-400 hover:text-blue-600 underline" id="regen-btn">Regenerate (AI)</button><button id="next-btn" onclick="app.nextQuestion()" class="bg-blue-600 text-white px-6 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-700 transition-colors" disabled>Next</button></div>
                </div>
            </div>

            <!-- HANDWRITING -->
            <div id="view-handwriting" class="view-section hidden max-w-3xl mx-auto">
                <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold mb-2 text-slate-800">Spatial & Handwriting Task</h3>
                    <p class="text-slate-600 text-sm mb-4">Instructions: Draw a <strong>triangle inside a square</strong>, and write the number <strong>8</strong>.</p>
                    <div class="relative w-full h-80 mb-4"><canvas id="drawingCanvas" class="w-full h-full rounded"></canvas><button onclick="app.clearCanvas()" class="absolute top-2 right-2 bg-white/90 border border-gray-300 text-xs px-2 py-1 rounded hover:bg-red-50 text-red-600">Clear</button></div>
                    <div class="flex flex-col md:flex-row gap-4 items-center justify-between border-t border-gray-100 pt-4"><div class="w-full md:w-auto"><label class="block text-xs font-medium text-slate-500 mb-1">Upload Previous Work</label><input type="file" id="file-upload-sim" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/></div><button onclick="app.saveHandwriting()" class="bg-indigo-600 text-white px-6 py-2 rounded hover:bg-indigo-700 shadow-sm w-full md:w-auto">Save Task</button></div>
                </div>
            </div>

            <!-- NEON RUNNER -->
            <div id="view-space-game" class="view-section hidden h-full flex flex-col p-4">
                <div class="relative w-full h-full bg-gray-900 rounded-xl overflow-hidden shadow-2xl border-4 border-slate-800 max-w-5xl mx-auto">
                    <canvas id="spaceCanvas" class="absolute inset-0 w-full h-full"></canvas>
                    <div class="absolute top-0 left-0 right-0 p-6 flex justify-between items-start pointer-events-none z-10">
                        <div class="bg-slate-900/80 backdrop-blur px-4 py-2 rounded border border-purple-500/30 text-purple-400 font-mono text-xl">Score: <span id="space-score-disp">0</span></div>
                        <div class="bg-slate-900/80 backdrop-blur px-6 py-3 rounded-xl border-2 border-white/20 text-white font-bold text-3xl" id="space-question-disp">READY</div>
                        <div class="bg-slate-900/80 backdrop-blur px-4 py-2 rounded border border-red-500/30 text-red-400 font-mono text-xl">Lives: <span id="space-lives-disp">3</span></div>
                    </div>
                    <div id="space-start-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 z-20 backdrop-blur-sm">
                        <h2 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 mb-4 drop-shadow-lg">NEON RUNNER</h2>
                        <button onclick="app.startSpaceGame()" class="px-8 py-3 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded-full shadow-lg transition transform hover:scale-105"><i class="fa-solid fa-play mr-2"></i> LAUNCH</button>
                    </div>
                    <div id="space-gameover-overlay" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-black/90 z-20">
                        <h2 class="text-4xl font-bold text-red-500 mb-2">GAME OVER</h2>
                        <p class="text-white text-xl mb-6">Score: <span id="space-final-score">0</span></p>
                        <button onclick="app.resetSpaceGameUI()" class="px-6 py-2 border border-white text-white hover:bg-white hover:text-black transition rounded">Try Again</button>
                        <button onclick="app.navigateTo('dashboard')" class="mt-4 text-gray-400 hover:text-white text-sm">Exit</button>
                    </div>
                </div>
            </div>

            <!-- AQUA MATH POP -->
            <div id="view-aqua-game" class="view-section hidden h-full flex flex-col p-4">
                <div class="relative w-full h-full bg-cyan-900 rounded-xl overflow-hidden shadow-2xl border-4 border-cyan-800 max-w-5xl mx-auto relative">
                    <canvas id="aquaCanvas" class="absolute inset-0 w-full h-full cursor-pointer"></canvas>
                    <div class="absolute top-4 left-0 right-0 text-center pointer-events-none">
                        <div class="inline-block bg-white/20 backdrop-blur-md px-8 py-3 rounded-full border border-white/40 text-white font-bold text-2xl shadow-lg">
                            Mission: <span id="aqua-mission" class="text-yellow-300">Pop Even Numbers!</span>
                        </div>
                    </div>
                    <div class="absolute top-4 right-4 bg-white/20 backdrop-blur px-4 py-2 rounded-lg border border-white/30 text-white font-mono pointer-events-none">
                        Score: <span id="aqua-score">0</span>
                    </div>
                    <!-- Start/End Overlay -->
                    <div id="aqua-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-cyan-900/90 z-20 backdrop-blur-sm">
                        <h2 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-300 to-blue-500 mb-4 drop-shadow-lg">AQUA MATH POP</h2>
                        <p class="text-cyan-100 mb-8 text-lg max-w-md text-center">Bubbles are floating up! Click the correct ones before they float away.</p>
                        <button onclick="app.startAquaGame()" class="px-8 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-bold rounded-full shadow-lg transition transform hover:scale-105">
                            <i class="fa-solid fa-play mr-2"></i> DIVE IN
                        </button>
                    </div>
                </div>
            </div>

            <!-- FACT MATCH -->
            <div id="view-fact-match" class="view-section hidden max-w-4xl mx-auto">
                <div class="bg-amber-50 p-6 rounded-xl border border-amber-200 shadow-sm min-h-[500px] flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-amber-800"><i class="fa-solid fa-puzzle-piece mr-2"></i>Fact Match</h3>
                        <div class="text-amber-700 font-mono bg-amber-100 px-3 py-1 rounded">Moves: <span id="match-moves">0</span></div>
                    </div>
                    <div id="match-grid" class="grid grid-cols-4 gap-4 flex-1">
                        <!-- Cards injected here -->
                    </div>
                    <div id="match-complete" class="hidden flex flex-col items-center justify-center mt-6 p-6 bg-white/50 rounded-lg">
                        <h4 class="text-xl font-bold text-green-600 mb-2">Level Complete!</h4>
                        <button onclick="app.startFactMatch()" class="bg-amber-600 text-white px-6 py-2 rounded hover:bg-amber-700">Play Again</button>
                    </div>
                </div>
            </div>

            <!-- REPORT -->
            <div id="view-report" class="view-section hidden max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-lg shadow-sm border border-slate-200">
                    <div class="text-center mb-8 border-b border-gray-100 pb-4">
                        <h2 class="text-2xl font-serif font-bold text-slate-800">Assessment Report</h2>
                        <p class="text-slate-500 text-sm mt-1">Numerical Skills Profile</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                        <div><h4 class="text-sm font-bold text-slate-700 uppercase tracking-wide mb-4">Performance Profile</h4><div class="relative h-64 w-full"><canvas id="radarChart"></canvas></div></div>
                        <div class="space-y-4">
                            <h4 class="text-sm font-bold text-slate-700 uppercase tracking-wide flex justify-between items-center">Summary <button onclick="app.generateReportInsights()" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200 transition"><i class="fa-solid fa-wand-magic-sparkles mr-1"></i> AI Analyze</button></h4>
                            <div class="bg-slate-50 p-4 rounded border border-slate-100 text-sm text-slate-700"><p><strong>Name:</strong> <span id="report-child-name">--</span></p><p><strong>Age:</strong> <span id="report-child-age">--</span></p></div>
                            <div id="report-insights" class="text-sm text-slate-600 space-y-2 prose prose-sm max-w-none"><p class="italic text-slate-400">Complete modules to generate insights.</p></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

<script>
    // --- JWT & API CONFIGURATION ---
    let currentUser = null;
    const API_BASE_URL = window.API_BASE_URL || 'http://localhost:5000/api';
    
    // JWT token management
    const tokenManager = {
        getToken: () => localStorage.getItem('access_token'),
        setToken: (token) => localStorage.setItem('access_token', token),
        clearToken: () => localStorage.removeItem('access_token'),
        isAuthenticated: () => !!localStorage.getItem('access_token')
    };
    
    // API helper function
    const apiCall = async (endpoint, options = {}) => {
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };
        
        const token = tokenManager.getToken();
        console.log(`[API] ${options.method || 'GET'} ${endpoint} - Token present: ${!!token}`);
        
        if (token) {
            headers['Authorization'] = `Bearer ${token}`;
        }
        
        try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 10000); // 10 second timeout
            
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...options,
                headers,
                signal: controller.signal
            });
            
            clearTimeout(timeout);
            
            console.log(`[API] Response: ${response.status}`);
            // Log raw response body for diagnostics
            try {
                const raw = await response.clone().text();
                console.log('[API] Raw response body:', raw);
            } catch (e) {
                console.warn('[API] Could not read response body');
            }

            if (response.status === 401) {
                tokenManager.clearToken();
                return null;
            }

            // Try to parse JSON, but if parsing fails log the raw text for diagnosis
            try {
                return await response.json();
            } catch (parseErr) {
                try {
                    const txt = await response.clone().text();
                    console.warn('[API] Response not JSON:', txt);
                } catch (tErr) {
                    console.warn('[API] Failed to read non-JSON response');
                }
                return null;
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                console.error('API Timeout:', endpoint);
                app.showNotification('Request timeout - Cloud service may be unavailable', 'error');
            } else {
                console.error('API Error:', error);
                app.showNotification('Network error occurred', 'error');
            }
            return null;
        }
    };

    const state = {
        profile: { childName: '', parentName: '', age: 8 },
        checklist: {},
        scores: { checklist: 0, magnitude: 0, estimation: 0, facts: 0, sequencing: 0, spatial: 0, memory: 0, handwriting: 0, consolidated: 0, neonRunner: 0, aquaMath: 0, factMatch: 0 },
        moduleCounts: { magnitude: 0, estimation: 0, facts: 0, sequencing: 0, spatial: 0, memory: 0, consolidated: 0 },
        totalQuestions: { magnitude: 0, estimation: 0, facts: 0, sequencing: 0, spatial: 0, memory: 0, consolidated: 0 },
        currentModuleData: [], currentQuestionIndex: 0, currentScoreInModule: 0
    };

    // Placeholder Question banks (used if AI generation fails or for simplicity)
    const fallbackQuestions = {
        magnitude: [{q:"Larger?",options:["15","51"],a:"51"},{q:"Smaller?",options:["102","98"],a:"98"},{q:"Largest",options:["33","43","34"],a:"43"},{q:"Which is smaller: 7 or 17?",options:["7","17"],a:"7"},{q:"Order from small to large: 9, 2, 5",options:["9, 2, 5","2, 5, 9"],a:"2, 5, 9"}],
        estimation: [{q:"12+29 approx?",options:["40","50","30"],a:"40"},{q:"105-48 approx?",options:["50","100","60"],a:"50"},{q:"Around how many apples are in 4 bags of 6?",options:["20","40"],a:"20"},{q:"Estimate 72 / 9",options:["8","10"],a:"8"},{q:"Is 39 + 18 closer to 50 or 60?",options:["50","60"],a:"60"}],
        facts: [{q:"7+6=",options:["13","14","12"],a:"13"},{q:"8x5=",options:["40","45","35"],a:"40"},{q:"9-2=",options:["6","7","8"],a:"7"},{q:"18/3=",options:["6","5","7"],a:"6"},{q:"4+9=",options:["13","14","15"],a:"13"}],
        sequencing: [{q:"2,4,6,?",options:["8","9","10"],a:"8"},{q:"10,20,30,?",options:["40","50","35"],a:"40"},{q:"5, 10, 15, ?",options:["18","20"],a:"20"},{q:"9, 7, 5, ?",options:["3","4"],a:"3"},{q:"1, 2, 4, 8, ?",options:["16","10"],a:"16"}],
        spatial: [{q:"3 sides?",options:["Triangle","Square"],a:"Triangle"},{q:"Cube is?",options:["2D","3D"],a:"3D"},{q:"Which shape has parallel sides?",options:["Circle","Rectangle"],a:"Rectangle"},{q:"How many corners does a square have?",options:["4","3"],a:"4"},{q:"Which way is left?",options:["\u2190 Left","Right \u2192"],a:"\u2190 Left"}],
        memory: [{q:"Remember 5,9. First?",options:["5","9"],a:"5"},{q:"Last of 842?",options:["2","4"],a:"2"},{q:"Recall: 7, 3, 1. Middle number?",options:["3","7"],a:"3"},{q:"Which number comes before 11?",options:["10","12"],a:"10"},{q:"Digits of 60: 6 and ...?",options:["0","1"],a:"0"}]
    };
    const checklistQuestions = ["Count backwards easily?", "Recognize number sequences?", "Use fingers for simple addition/subtraction (age 8+)?", "Estimate quantities accurately?", "Tell analog time and manage time?", "Quickly recall multiplication facts?", "Align numbers correctly for column math?", "Show high math anxiety or avoidance?"];

    // --- GAMES CLASSES ---
    class SpaceGame {
        constructor() {
            this.canvas = document.getElementById('spaceCanvas');
            this.ctx = this.canvas.getContext('2d');
            this.active = false;
            this.resize();
            window.addEventListener('resize', () => this.resize());
            this.canvas.addEventListener('mousemove', e => this.playerX = e.clientX - this.canvas.getBoundingClientRect().left);
            this.canvas.addEventListener('touchmove', e => { e.preventDefault(); this.playerX = e.touches[0].clientX - this.canvas.getBoundingClientRect().left; }, {passive: false});
        }
        resize() { if(this.canvas.parentElement) { this.canvas.width = this.canvas.parentElement.clientWidth; this.canvas.height = this.canvas.parentElement.clientHeight; this.playerY = this.canvas.height - 100; } }
        start() {
            this.active = true; this.score = 0; this.lives = 3; this.gates = []; this.particles = []; this.speed = 1.5; this.playerX = this.canvas.width / 2;
            this.stars = Array(100).fill().map(()=>({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height,size:Math.random()*2,speed:Math.random()*3+0.5}));
            this.spawnGate(); requestAnimationFrame(t => this.loop(t));
        }
        updateUI() { document.getElementById('space-score-disp').innerText = this.score; document.getElementById('space-lives-disp').innerText = "❤️".repeat(this.lives); if(this.currEq) document.getElementById('space-question-disp').innerText = this.currEq.text; }
        spawnGate() {
            let a=Math.floor(Math.random()*10)+2, b=Math.floor(Math.random()*10)+1, op=Math.random()>.5?'+':'x', ans=op==='+'?a+b:a*b;
            if (op === 'x' && a*b > 50) ans = a*b, a = 10, b = 5; // Keep multiplication simple
            if(op==='+'&&a+b>20) ans=a+b, a=10, b=10; // Keep addition simple
            this.currEq={text:`${a} ${op} ${b} = ?`,ans};
            this.updateUI();
            let wrong=ans+(Math.random()>.5?1:-1)*(Math.floor(Math.random()*3)+1);
            if (wrong === ans) wrong += 1; // Ensure wrong answer is different
            this.gates.push({y:-100,left:Math.random()>.5,cor:ans,wro:wrong,hit:false});
        }
        loop() {
            if(!this.active) return;
            this.ctx.fillStyle='#0f172a'; this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);
            this.ctx.fillStyle='#fff'; this.stars.forEach(s=>{s.y+=s.speed;if(s.y>this.canvas.height)s.y=0;this.ctx.beginPath();this.ctx.arc(s.x,s.y,s.size,0,Math.PI*2);this.ctx.fill()});
            
            if(this.gates.length===0||this.gates[this.gates.length-1].y>250) if(Math.random()<.02) this.spawnGate();
            
            this.gates.forEach(g => {
                g.y+=this.speed;
                let mid=this.canvas.width/2, gw=120, gh=80, lx=mid-150-gw/2, rx=mid+150-gw/2;
                this.ctx.fillStyle=g.left?'rgba(34,197,94,0.2)':'rgba(239,68,68,0.2)'; this.ctx.strokeStyle=g.left?'#22c55e':'#ef4444';
                this.ctx.lineWidth=2; this.ctx.fillRect(lx,g.y,gw,gh); this.ctx.strokeRect(lx,g.y,gw,gh); this.ctx.fillRect(rx,g.y,gw,gh); this.ctx.strokeRect(rx,g.y,gw,gh);
                this.ctx.fillStyle='#fff'; this.ctx.font='bold 30px monospace'; this.ctx.textAlign='center';
                this.ctx.fillText(g.left?g.cor:g.wro,lx+gw/2,g.y+50); this.ctx.fillText(g.left?g.wro:g.cor,rx+gw/2,g.y+50);

                if(!g.hit && g.y+gh>this.playerY && g.y<this.playerY+40) {
                    const playerCenter = this.playerX;
                    const isPlayerLeft = playerCenter < mid;
                    
                    if (isPlayerLeft === g.left) { 
                        this.score+=10; 
                        this.speed=Math.min(4, this.speed+0.05); 
                        g.hit=true; 
                        app.showNotification("Correct! +10", "success");
                    } 
                    else { 
                        this.lives--; 
                        g.hit=true; 
                        app.showNotification("Wrong answer!", "error");
                        if(this.lives<=0){
                            this.active=false;
                            document.getElementById('space-gameover-overlay').classList.remove('hidden');
                            document.getElementById('space-final-score').innerText=this.score;
                            if(this.score>state.scores.neonRunner){
                                state.scores.neonRunner=this.score;
                                apiCall('/assessment/game-score', {
                                    method: 'POST',
                                    body: JSON.stringify({
                                        game_name: 'neon_runner',
                                        score: this.score
                                    })
                                });
                                app.saveData();
                            }
                        }
                    }
                    this.updateUI();
                }
            });
            this.gates=this.gates.filter(g=>g.y<this.canvas.height+100);
            
            // Draw Player Ship (Simple triangle)
            this.ctx.save(); this.ctx.translate(this.playerX,this.playerY); this.ctx.beginPath(); this.ctx.moveTo(0,-30); this.ctx.lineTo(20,20); this.ctx.lineTo(0,10); this.ctx.lineTo(-20,20); this.ctx.closePath(); this.ctx.fillStyle='#c026d3'; this.ctx.fill(); this.ctx.restore();
            requestAnimationFrame(()=>this.loop());
        }
    }

    class AquaGame {
        constructor() {
            this.canvas = document.getElementById('aquaCanvas');
            this.ctx = this.canvas.getContext('2d');
            this.active = false;
            this.bubbles = [];
            this.resize();
            window.addEventListener('resize', () => this.resize());
            this.canvas.addEventListener('click', (e) => this.handleClick(e));
            this.canvas.addEventListener('touchstart', (e) => {
                const r = this.canvas.getBoundingClientRect();
                this.handleClick({offsetX: e.touches[0].clientX - r.left, offsetY: e.touches[0].clientY - r.top});
            }, {passive: false});
            this.gameTimer = null;
        }
        resize() { if(this.canvas.parentElement){this.canvas.width=this.canvas.parentElement.clientWidth;this.canvas.height=this.canvas.parentElement.clientHeight;} }
        start() {
            this.active = true; this.score = 0; this.bubbles = []; this.frameCount = 0;
            this.rule = Math.random() > 0.5 ? "even" : "odd";
            document.getElementById('aqua-mission').innerText = this.rule === "even" ? "Pop Even Numbers!" : "Pop Odd Numbers!";
            document.getElementById('aqua-overlay').classList.add('hidden');
            document.getElementById('aqua-score').innerText = this.score;

            if (this.gameTimer) clearTimeout(this.gameTimer);
            this.gameTimer = setTimeout(() => this.stop(), 30000); // 30 second game
            
            requestAnimationFrame(() => this.loop());
        }
        spawnBubble() {
            const r = 30 + Math.random()*20;
            const speedOffset = Math.min(1.5, this.score / 200); // Speed up over time
            this.bubbles.push({
                x: r + Math.random() * (this.canvas.width - 2*r),
                y: this.canvas.height + r,
                r: r,
                val: Math.floor(Math.random() * 50) + 1,
                speed: (0.5 + Math.random() * 1.0) + speedOffset, 
                color: `hsla(${180 + Math.random()*40}, 80%, 60%, 0.6)`
            });
        }
        handleClick(e) {
            if (!this.active) return;
            const ex = e.offsetX, ey = e.offsetY;
            for (let i = this.bubbles.length - 1; i >= 0; i--) {
                const b = this.bubbles[i];
                const dist = Math.sqrt((ex - b.x)**2 + (ey - b.y)**2);
                if (dist < b.r) {
                    const isEven = b.val % 2 === 0;
                    const correct = (this.rule === "even" && isEven) || (this.rule === "odd" && !isEven);
                    if (correct) { 
                        this.score += 10; 
                        app.showNotification("POP! Correct.", "success");
                    } else { 
                        this.score = Math.max(0, this.score - 5); 
                        app.showNotification("Miss! Wrong number.", "error");
                    }
                    document.getElementById('aqua-score').innerText = this.score;
                    this.bubbles.splice(i, 1);
                    break;
                }
            }
        }
        loop() {
            if (!this.active) return;
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.frameCount++;
            if (this.frameCount % Math.max(20, 60 - Math.floor(this.score/50)) === 0) this.spawnBubble(); // Faster spawns over time

            // Draw Bubbles
            this.ctx.strokeStyle = '#fff';
            this.ctx.lineWidth = 2;
            this.ctx.textAlign = 'center';
            this.ctx.textBaseline = 'middle';
            this.ctx.font = 'bold 20px Inter';

            this.bubbles.forEach(b => {
                b.y -= b.speed;
                this.ctx.fillStyle = b.color;
                this.ctx.beginPath();
                this.ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
                this.ctx.fill();
                this.ctx.stroke();
                this.ctx.fillStyle = '#fff';
                this.ctx.fillText(b.val, b.x, b.y);
            });

            // Cleanup offscreen
            this.bubbles = this.bubbles.filter(b => b.y + b.r > -50);
            
            requestAnimationFrame(() => this.loop());
        }
        stop() {
            this.active = false;
            if (this.gameTimer) clearTimeout(this.gameTimer);
            if (this.score > state.scores.aquaMath) { 
                state.scores.aquaMath = this.score; 
                apiCall('/assessment/game-score', {
                    method: 'POST',
                    body: JSON.stringify({
                        game_name: 'aqua_math',
                        score: this.score
                    })
                });
                app.saveData(); 
            }
            document.getElementById('aqua-overlay').innerHTML = `
                <h2 class="text-4xl font-bold text-cyan-300 mb-2">TIME UP!</h2>
                <p class="text-white text-xl mb-6">Final Score: <span class="font-bold text-yellow-300">${this.score}</span></p>
                <button onclick="app.startAquaGame()" class="px-6 py-2 border border-white text-white hover:bg-white hover:text-black transition rounded">Play Again</button>
                <button onclick="app.navigateTo('dashboard')" class="mt-4 text-gray-400 hover:text-white text-sm">Exit</button>
            `;
            document.getElementById('aqua-overlay').classList.remove('hidden');
        }
    }

    const spaceGame = new SpaceGame();
    const aquaGame = new AquaGame();

    window.app = {
        // In index.html, replace the init function:

init: async () => {
    console.log('[INIT] Starting initialization...');
    console.log('[INIT] Token present:', tokenManager.isAuthenticated());
    
    if (tokenManager.isAuthenticated()) {
        try {
            const result = await apiCall('/auth/verify', { method: 'GET' });
            console.log('[INIT] Verify result:', result);
            
            if (result && result.user) {
                currentUser = result.user;
                console.log('[INIT] User authenticated:', currentUser.username);
                
                // Load profile from backend
                await app.loadUserProfile();
                console.log('[INIT] Profile loaded:', state.profile);
                
                document.getElementById('auth-text').innerText = currentUser.email || 'Authenticated';
                document.getElementById('auth-indicator').classList.replace('bg-gray-300', 'bg-green-500');
                document.getElementById('user-id-display').innerText = currentUser.email || currentUser.id;
                app.showNotification('Token verified — welcome back', 'success');
                
                // Check if profile setup is needed
                if (!state.profile.childName) {
                    console.log('[INIT] No child name found, showing profile setup');
                    app.showAuthUI('view-profile-setup');
                } else {
                    console.log('[INIT] Profile exists, showing app UI');
                    app.showAppUI();
                }
            } else {
                console.log('[INIT] Verify failed, clearing token');
                app.showNotification('Token verification failed — please sign in', 'error');
                tokenManager.clearToken();
                app.showLoginUI();
            }
        } catch (error) {
            console.error('[INIT] Error during verify:', error);
            app.showNotification('Error verifying token — sign in again', 'error');
            tokenManager.clearToken();
            app.showLoginUI();
        }
    } else {
        console.log('[INIT] No token found, showing login');
        app.showLoginUI();
    }
    
    app.renderChecklistForm();
    app.initCanvas();
},

        showLoginUI: () => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            
            // Create or show login section
            let loginView = document.getElementById('view-login');
            if (!loginView) {
                const contentArea = document.getElementById('content-area');
                loginView = document.createElement('div');
                loginView.id = 'view-login';
                loginView.className = 'view-section flex items-center justify-center h-full -mt-16';
                loginView.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-lg border border-slate-200 w-full max-w-md">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4">
                                <i class="fa-solid fa-brain"></i>
                            </div>
                            <h1 class="text-2xl font-bold text-slate-800">NumSkills<span class="text-blue-600">Pro</span></h1>
                            <p class="text-slate-500 text-sm mt-2">Secure Assessment Platform</p>
                        </div>
                        
                        <div class="space-y-4">
                            <input type="text" id="login-username" placeholder="Username or Email" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            <input type="password" id="login-password" placeholder="Password" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                            <button onclick="app.handleLogin()" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition shadow-sm font-medium">
                                Sign In
                            </button>
                        </div>
                        
                        <div class="mt-6 pt-6 border-t border-gray-100">
                            <p class="text-sm text-slate-600 text-center mb-4">New user?</p>
                            <input type="text" id="reg-username" placeholder="Choose Username" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 outline-none mb-2">
                            <input type="email" id="reg-email" placeholder="Email Address" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 outline-none mb-2">
                            <input type="password" id="reg-password" placeholder="Create Password" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 outline-none mb-2">
                            <button onclick="app.handleRegisterNew()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition shadow-sm font-medium">
                                Create Account
                            </button>
                        </div>
                    </div>
                `;
                contentArea.insertBefore(loginView, contentArea.firstChild);
            }
            
            loginView.classList.remove('hidden');
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('main-header').classList.add('hidden');
        },

        handleLogin: async () => {
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    
    if (!username || !password) {
        app.showNotification('Please enter username/email and password', 'error');
        return;
    }
    
    console.log('[LOGIN] Attempting login for:', username);
    
    const result = await apiCall('/auth/login', {
        method: 'POST',
        body: JSON.stringify({
            username: username.includes('@') ? undefined : username,
            email: username.includes('@') ? username : undefined,
            password: password
        })
    });
    
    console.log('[LOGIN] Login response:', result);
    
    if (result && result.access_token) {
        tokenManager.setToken(result.access_token);
        currentUser = result.user;
        console.log('[LOGIN] Token stored, calling init()');
        app.showNotification('Login successful!', 'success');
        
        // Reinitialize immediately to apply the token
        try { await app.init(); } catch (e) { console.error('Init after login failed', e); }
    } else {
        app.showNotification(result?.error || 'Login failed', 'error');
    }
},

        handleRegisterNew: async () => {
            const username = document.getElementById('reg-username').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const password = document.getElementById('reg-password').value;
            
            if (!username || !email || !password) {
                app.showNotification('Please fill in all fields', 'error');
                return;
            }
            
            const result = await apiCall('/auth/register', {
                method: 'POST',
                body: JSON.stringify({ username, email, password })
            });
            
            if (result && result.access_token) {
                tokenManager.setToken(result.access_token);
                currentUser = result.user;
                app.showNotification('Account created successfully!', 'success');
                app.init();
            } else {
                app.showNotification(result?.error || 'Registration failed', 'error');
            }
        },

        loadUserProfile: async () => {
            console.log('[PROFILE] Loading user profile...');
            try {
                const result = await apiCall('/assessment/profile', { method: 'GET' });
                console.log('[PROFILE] Profile API result:', result);
                
                if (result && result.profile) {
                    const p = result.profile;
                    state.profile = {
                        childName: p.child_name || '',
                        parentName: p.parent_name || '',
                        age: p.child_age || 8
                    };
                    console.log('[PROFILE] Profile updated from API:', state.profile);
                } else if (result && result.child_name) {
                    // Handle case where API returns flat object
                    state.profile = {
                        childName: result.child_name || '',
                        parentName: result.parent_name || '',
                        age: result.child_age || 8
                    };
                    console.log('[PROFILE] Profile updated (flat response):', state.profile);
                } else {
                    console.log('[PROFILE] No profile data found, using defaults');
                }
            } catch (error) {
                console.error('[PROFILE] Error loading profile:', error);
            }
        },
        
        // Auth UI Toggles - Now accepts an optional target view ID
        showAuthUI: (targetView = 'view-loading') => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(targetView).classList.remove('hidden');
            document.getElementById('sidebar').classList.add('hidden');
            document.getElementById('main-header').classList.add('hidden');
            document.getElementById('main-container').classList.remove('md:ml-64');
            // If showing profile setup, pre-fill if data was loaded from local storage
            if (targetView === 'view-profile-setup') {
                document.getElementById('child-name-init').value = state.profile.childName || '';
                document.getElementById('child-age-init').value = state.profile.age || 8;
                document.getElementById('parent-name-init').value = state.profile.parentName || '';
            }
        },

        showAppUI: () => {
            document.getElementById('view-loading').classList.add('hidden');
            document.getElementById('view-profile-setup').classList.add('hidden'); // Hide setup just in case
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('main-header').classList.remove('hidden');
            document.getElementById('main-container').classList.add('md:ml-64');
            app.navigateTo('dashboard');
        },

        // Auth/Logout
        signOutUser: async () => {
            tokenManager.clearToken();
            currentUser = null;
            app.showLoginUI();
            app.showNotification('Signed out successfully', 'success');
        },

        // Data Management Logic
        saveData: async (manual) => {
            if (!currentUser) {
                app.showNotification('Not authenticated', 'error');
                return;
            }
            
            try {
                // Save profile
                await apiCall('/assessment/profile', {
                    method: 'POST',
                    body: JSON.stringify({
                        child_name: state.profile.childName,
                        child_age: state.profile.age,
                        parent_name: state.profile.parentName
                    })
                });
                
                if (manual) app.showNotification('Saved to Cloud');
                app.updateDashboardUI();
            } catch (e) {
                console.error('Error saving data:', e);
                if (manual) app.showNotification('Error saving data!', 'error');
            }
        },
        
        // Manual Cloud Sync (Backup/Restore for Drive)
        exportData: () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `numskills_backup_${state.profile.childName || 'data'}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        },

        importData: (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    Object.assign(state, imported);
                    app.updateDashboardUI();
                    app.saveData(true); 
                    app.showNotification("Data Imported Successfully!");
                } catch (err) {
                    app.showNotification("Invalid file format", "error");
                }
            };
            reader.readAsText(file);
        },

        navigateTo: (viewId) => {
            spaceGame.active = false; aquaGame.active = false; 
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'theme-green', 'theme-purple', 'theme-cyan', 'theme-amber', 'border-r-4', 'border-blue-600', 'font-semibold'));
            
            let target = '', navId = `nav-${viewId}`;
            if (viewId.startsWith('module-')) { 
                target = 'view-game'; 
                app.startModule(viewId.split('-')[1]); 
                const titleMap = { magnitude: "Number Magnitude", estimation: "Estimation Tasks", facts: "Fact Retrieval", sequencing: "Number Sequencing", spatial: "Spatial Reasoning", memory: "Working Memory", consolidated: "Consolidated Exam" };
                document.getElementById('game-title').innerText = titleMap[viewId.split('-')[1]] || 'Assessment Module';
            }
            else target = `view-${viewId}`;
            
            const targetEl = document.getElementById(target);
            if(targetEl) targetEl.classList.remove('hidden');
            
            document.getElementById('page-title').innerText = document.getElementById(navId)?.innerText.trim() || target.replace('view-', '').toUpperCase();

            const navEl = document.getElementById(navId);
            if(navEl) {
                navEl.classList.add('active');
                if(viewId === 'module-consolidated') navEl.classList.add('theme-green');
                if(viewId === 'space-game') navEl.classList.add('theme-purple');
                if(viewId === 'aqua-game') navEl.classList.add('theme-cyan');
                if(viewId === 'fact-match') navEl.classList.add('theme-amber');
            }
            if(viewId==='fact-match') app.startFactMatch();
            if(viewId==='space-game') setTimeout(()=>spaceGame.resize(), 100);
            if(viewId==='aqua-game') setTimeout(()=>aquaGame.resize(), 100);
            if(viewId==='dashboard') app.updateDashboardUI();
            if(viewId==='report') app.renderReport();
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full');
        },

        // Games Logic
        startFactMatch: () => {
            const grid = document.getElementById('match-grid'); grid.innerHTML = ''; document.getElementById('match-complete').classList.add('hidden');
            const pairs = [{q:'2+2', a:'4'}, {q:'5+3', a:'8'}, {q:'10-4', a:'6'}, {q:'3x3', a:'9'},{q:'Half of 10', a:'5'}, {q:'12-2', a:'10'}, {q:'4+1', a:'5'}, {q:'1+1', a:'2'}];
            const deck = []; pairs.slice(0, 8).forEach((p, i) => { deck.push({ id: i, text: p.q, type: 'q', matchId: i }); deck.push({ id: i, text: p.a, type: 'a', matchId: i }); });
            deck.sort(() => Math.random() - 0.5);
            let firstCard = null, moves = 0, matches = 0;
            document.getElementById('match-moves').innerText = 0;
            
            const totalCards = deck.length;
            const maxScore = 100;
            const perfectMoves = totalCards; 
            const movesPenalty = 5; 

            deck.forEach((card, index) => {
                const el = document.createElement('div'); el.className = 'memory-card cursor-pointer h-24';
                el.id = `card-${index}`;
                el.innerHTML = `<div class="memory-inner"><div class="memory-front flex-col text-sm"><i class="fa-solid fa-square-root-variable text-2xl mb-1"></i>Tap to Flip</div><div class="memory-back">${card.text}</div></div>`;
                el.onclick = () => {
                    if (el.classList.contains('flipped') || el.classList.contains('matched') || document.querySelectorAll('.flipped:not(.matched)').length >= 2) return;
                    el.classList.add('flipped');
                    if (!firstCard) { firstCard = { el, card }; } 
                    else {
                        moves++; document.getElementById('match-moves').innerText = moves;
                        if (firstCard.card.matchId === card.matchId) {
                            el.classList.add('matched'); firstCard.el.classList.add('matched'); firstCard = null; matches++;
                            if(matches === 8) { 
                                const finalScore = Math.max(0, maxScore - Math.max(0, moves - perfectMoves) * movesPenalty);
                                document.getElementById('match-complete').classList.remove('hidden');
                                
                                if (finalScore > state.scores.factMatch) {
                                    state.scores.factMatch = finalScore;
                                    apiCall('/assessment/game-score', {
                                        method: 'POST',
                                        body: JSON.stringify({
                                            game_name: 'fact_match',
                                            score: finalScore
                                        })
                                    });
                                }
                                app.saveData(false); 
                            }
                        } else { 
                            const card1 = firstCard.el;
                            const card2 = el;
                            firstCard = null;
                            setTimeout(() => { 
                                card1.classList.remove('flipped'); 
                                card2.classList.remove('flipped'); 
                            }, 1000); 
                        }
                    }
                };
                grid.appendChild(el);
            });
        },
        startAquaGame: () => { aquaGame.start(); },
        startSpaceGame: () => { document.getElementById('space-start-overlay').classList.add('hidden'); document.getElementById('space-gameover-overlay').classList.add('hidden'); spaceGame.start(); },
        resetSpaceGameUI: () => { document.getElementById('space-start-overlay').classList.remove('hidden'); document.getElementById('space-gameover-overlay').classList.add('hidden'); },

        // Modules Logic
        startModule: async (type) => {
            const isConsolidated = type === 'consolidated';
            const cont = document.getElementById('game-container');
            cont.className = isConsolidated ? "bg-green-50 p-6 rounded-lg shadow-sm border border-green-200 min-h-[400px] flex flex-col transition-colors" : "bg-white p-6 rounded-lg shadow-sm border border-slate-200 min-h-[400px] flex flex-col transition-colors";
            
            document.getElementById('loading-overlay').classList.remove('hidden');
            await new Promise(r => setTimeout(r, 500)); 

            state.currentModuleType = type;
            let questions;

            if (type === 'consolidated') {
                questions = [
                    ...fallbackQuestions.magnitude.slice(0, 1),
                    ...fallbackQuestions.estimation.slice(0, 1),
                    ...fallbackQuestions.facts.slice(0, 1),
                    ...fallbackQuestions.sequencing.slice(0, 1),
                    ...fallbackQuestions.spatial.slice(0, 1),
                    ...fallbackQuestions.memory.slice(0, 1)
                ];
                questions.sort(() => Math.random() - 0.5); 
            } else {
                questions = fallbackQuestions[type] || fallbackQuestions['magnitude'];
            }
            
            state.currentModuleData = questions.map(q => ({...q, userAnswer: undefined, isCorrect: undefined})); 
            state.totalQuestions[type] = questions.length;
            state.currentQuestionIndex = 0; 
            state.currentScoreInModule = 0;
            
            document.getElementById('loading-overlay').classList.add('hidden');
            app.renderQuestion();
        },

        renderQuestion: () => {
            const questions = state.currentModuleData;
            const q = questions[state.currentQuestionIndex];
            
            document.getElementById('next-btn').disabled = true;
            document.getElementById('game-feedback').innerHTML = '';
            
            if(!q) { app.finishModule(); return; }

            document.getElementById('game-progress').innerText = `Q: ${state.currentQuestionIndex + 1}/${questions.length}`;
            document.getElementById('question-text').innerText = q.q;
            const div = document.getElementById('answers-area'); div.innerHTML = '';

            const isAnswered = q.userAnswer !== undefined;

            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full p-4 text-left border-2 border-slate-200 rounded transition font-medium text-slate-700 hover:bg-blue-50 hover:border-blue-500 shadow-sm";
                btn.innerText = opt;
                btn.setAttribute('data-answer', opt);

                if (isAnswered) {
                    btn.disabled = true;
                    if (opt === q.a) {
                        btn.classList.replace('hover:bg-blue-50', 'bg-green-100');
                        btn.classList.add('border-green-600', 'text-green-800');
                    } else if (opt === q.userAnswer) {
                        btn.classList.replace('hover:bg-blue-50', 'bg-red-100');
                        btn.classList.add('border-red-600', 'text-red-800');
                    }
                } else {
                    btn.onclick = () => { 
                        q.userAnswer = opt;
                        const isCorrect = opt === q.a;
                        q.isCorrect = isCorrect;
                        
                        document.getElementById('game-feedback').innerHTML = `<span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">${isCorrect ? 'Correct Answer!' : 'Incorrect. The correct answer is ' + q.a}</span>`;
                        document.getElementById('next-btn').disabled = false;
                        
                        document.querySelectorAll('#answers-area button').forEach(b => {
                            b.disabled = true;
                            if (b.getAttribute('data-answer') === q.a) {
                                b.classList.replace('hover:bg-blue-50', 'bg-green-100');
                                b.classList.add('border-green-600', 'text-green-800');
                            } else if (b.getAttribute('data-answer') === opt && !isCorrect) {
                                b.classList.replace('hover:bg-blue-50', 'bg-red-100');
                                b.classList.add('border-red-600', 'text-red-800');
                            }
                        });
                    };
                }
                div.appendChild(btn);
            });
            if (isAnswered) document.getElementById('next-btn').disabled = false;
        },

        nextQuestion: () => { 
            const q = state.currentModuleData[state.currentQuestionIndex];
            if (q && q.isCorrect) state.currentScoreInModule++; 
            
            state.currentQuestionIndex++; 
            app.renderQuestion(); 
        },

        finishModule: async () => { 
            const total = state.currentModuleData.length;
            const scorePct = Math.round((state.currentScoreInModule / total) * 100);
            state.scores[state.currentModuleType] = scorePct;
            
            // Save score to API
            await apiCall('/assessment/score', {
                method: 'POST',
                body: JSON.stringify({
                    module: state.currentModuleType,
                    score: state.currentScoreInModule,
                    total: total,
                    answers: state.currentModuleData
                })
            });
            
            app.saveData(true); 
            app.showNotification(`Module Complete! Score: ${scorePct}%`, "success");
            app.navigateTo('dashboard'); 
        },

        updateDashboardUI: () => {
            // Update Dashboard fields
            document.getElementById('child-name').value = state.profile.childName || '';
            document.getElementById('child-age').value = state.profile.age || '';
            document.getElementById('parent-name').value = state.profile.parentName || '';
            
            // Update initial setup fields (important if data loaded asynchronously)
            document.getElementById('child-name-init').value = state.profile.childName || '';
            document.getElementById('child-age-init').value = state.profile.age || 8;
            document.getElementById('parent-name-init').value = state.profile.parentName || '';

            document.getElementById('dash-neon').innerText = state.scores.neonRunner || 0;
            document.getElementById('dash-aqua').innerText = state.scores.aquaMath || 0;
            
            const checklistValues = Object.values(state.checklist);
            const riskScore = checklistValues.filter(v => v === 'yes').length;
            state.scores.checklist = riskScore;
            
            const modules = ['magnitude', 'estimation', 'facts', 'sequencing', 'spatial', 'memory', 'handwriting', 'consolidated'];
            let completed = 0;
            modules.forEach(m => { 
                if (m === 'handwriting' && state.scores.handwriting > 0) completed++; 
                else if (m !== 'handwriting' && state.scores[m] > 0) completed++;
            });
            
            const totalModules = modules.length;
            const pct = Math.round((completed / totalModules) * 100);
            
            if(document.getElementById('progress-percent')) document.getElementById('progress-percent').innerText = pct + '%';
            if(document.getElementById('progress-bar')) document.getElementById('progress-bar').style.width = pct + '%';
            if(document.getElementById('dashboard-modules-count')) document.getElementById('dashboard-modules-count').innerText = `${completed}/${totalModules}`;
        },

        // Handle profile registration
        handleRegistration: async (e, isInitial = false) => { 
            e.preventDefault(); 
            let nameEl, ageEl, parentEl;

            if (isInitial) {
                nameEl = document.getElementById('child-name-init');
                ageEl = document.getElementById('child-age-init');
                parentEl = document.getElementById('parent-name-init');
            } else {
                nameEl = document.getElementById('child-name');
                ageEl = document.getElementById('child-age');
                parentEl = document.getElementById('parent-name');
            }
            
            state.profile.childName = nameEl.value.trim(); 
            state.profile.age = parseInt(ageEl.value) || 0; 
            state.profile.parentName = parentEl.value.trim();
            
            if (!state.profile.childName) {
                app.showNotification("Child's Name is required to proceed.", "error");
                return;
            }

            await app.saveData(true); 
            
            if (isInitial) {
                app.showNotification("Profile created! Starting assessment.", "success");
                app.showAppUI();
            }
        },
        
        showNotification: (msg, type='success') => { 
            const n = document.getElementById('notification'); 
            const m = document.getElementById('notification-msg');
            m.innerText=msg; 
            n.classList.remove('border-red-500', 'border-green-500', 'border-blue-500');
            if(type==='error') n.classList.add('border-red-500'); 
            else if(type==='success') n.classList.add('border-green-500');
            else n.classList.add('border-blue-500');
            n.classList.remove('translate-x-full'); 
            setTimeout(()=>n.classList.add('translate-x-full'),3000); 
        },

        renderChecklistForm: () => { 
            const c = document.getElementById('checklist-container'); if(!c) return; 
            c.innerHTML = checklistQuestions.map((q, idx) => `
                <div class="flex items-center justify-between border-b border-gray-100 pb-4 last:border-b-0">
                    <span class="text-slate-700 text-sm md:text-base flex-1 mr-4">${idx + 1}. ${q}</span>
                    <div class="flex gap-4">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="q${idx}" value="yes" class="form-radio text-blue-600 h-4 w-4" onchange="app.updateChecklistState(${idx}, 'yes')" ${state.checklist[idx]==='yes'?'checked':''}>
                            <span class="ml-2 text-sm">Yes</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="q${idx}" value="no" class="form-radio text-blue-600 h-4 w-4" onchange="app.updateChecklistState(${idx}, 'no')" ${state.checklist[idx]==='no'?'checked':''}>
                            <span class="ml-2 text-sm">No</span>
                        </label>
                    </div>
                </div>
            `).join(''); 
        },
        updateChecklistState: (idx, val) => { state.checklist[idx] = val; },
        submitChecklist: async (e) => { 
            e.preventDefault(); 
            const allAnswered = checklistQuestions.every((_, idx) => state.checklist[idx] !== undefined);
            if (!allAnswered) {
                app.showNotification("Please answer all checklist questions.", "error");
                return;
            }
            
            // Convert checklist to responses object
            const responses = {};
            Object.keys(state.checklist).forEach(idx => {
                responses[idx] = state.checklist[idx] === 'yes';
            });
            
            // Save to API
            await apiCall('/assessment/checklist', {
                method: 'POST',
                body: JSON.stringify({ responses })
            });
            
            app.saveData(true); 
            app.showNotification("Checklist saved and score updated!"); 
            app.navigateTo('dashboard'); 
        },
        
        initCanvas: () => { 
            const canvas = document.getElementById('drawingCanvas'); if(!canvas) return; const ctx = canvas.getContext('2d'); let painting = false;
            const resize = () => { const r = canvas.getBoundingClientRect(); canvas.width = r.width; canvas.height = r.height; ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#2c3e50'; };
            window.addEventListener('resize', resize); resize();
            function getCoords(e) { const r = canvas.getBoundingClientRect(); const cx = e.touches ? e.touches[0].clientX : e.clientX; const cy = e.touches ? e.touches[0].clientY : e.clientY; return {x: cx-r.left, y: cy-r.top}; }
            function startPosition(e) { painting = true; const coords = getCoords(e); ctx.beginPath(); ctx.moveTo(coords.x, coords.y); } 
            function finishedPosition() { painting = false; }
            function draw(e) { if (!painting) return; e.preventDefault(); const coords = getCoords(e); ctx.lineTo(coords.x, coords.y); ctx.stroke(); }
            canvas.addEventListener('mousedown', startPosition); canvas.addEventListener('mouseup', finishedPosition); canvas.addEventListener('mousemove', draw); 
            canvas.addEventListener('touchstart', startPosition, {passive: false}); canvas.addEventListener('touchend', finishedPosition); canvas.addEventListener('touchmove', draw, {passive: false});
        },
        clearCanvas: () => { 
            const c=document.getElementById('drawingCanvas'); 
            c.getContext('2d').clearRect(0,0,c.width,c.height); 
            app.showNotification("Canvas cleared.");
        },
        saveHandwriting: () => { 
            state.scores.handwriting=100; 
            app.saveData(true); 
            app.showNotification("Handwriting task saved (Score: 100 - Completion only)");
            app.navigateTo('dashboard'); 
        },
        
        // Report Logic
        renderReport: () => { 
            const labels = ["Magnitude", "Estimation", "Facts", "Sequencing", "Spatial", "Memory", "Neon Runner", "Aqua Math Pop", "Fact Match"];
            const data = [
                state.scores.magnitude || 0,
                state.scores.estimation || 0,
                state.scores.facts || 0,
                state.scores.sequencing || 0,
                state.scores.spatial || 0,
                state.scores.memory || 0,
                Math.min(100, (state.scores.neonRunner || 0) / 2),
                Math.min(100, (state.scores.aquaMath || 0) / 2),
                state.scores.factMatch || 0
            ];
            
            const ctx = document.getElementById('radarChart').getContext('2d');
            if(window.myRadar) window.myRadar.destroy();

            window.myRadar = new Chart(ctx, { 
                type: 'radar', 
                data: { 
                    labels, 
                    datasets: [{ 
                        label: 'Performance Score (0-100)', 
                        data, 
                        backgroundColor: 'rgba(59,130,246,0.2)', 
                        borderColor: '#3b82f6',
                        pointBackgroundColor: '#3b82f6',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#3b82f6'
                    }] 
                }, 
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        r: { 
                            suggestedMin: 0, 
                            suggestedMax: 100,
                            pointLabels: {
                                font: { size: 11, family: 'Inter' }
                            },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            angleLines: { color: 'rgba(0, 0, 0, 0.1)' }
                        } 
                    },
                    plugins: { legend: { display: false } }
                } 
            });
            document.getElementById('report-child-name').innerText = state.profile.childName || '--';
            document.getElementById('report-child-age').innerText = state.profile.age || '--';

            // Report Insights (Placeholder)
            const insightText = `
                <h5 class="text-base font-semibold text-slate-800">Manual Summary</h5>
                <p><strong>Checklist Score:</strong> ${state.scores.checklist}/${checklistQuestions.length} signs observed.</p>
                <p class="text-slate-500 italic">No AI analysis available in this environment. Please complete all modules and games to establish a complete profile.</p>
            `;
            document.getElementById('report-insights').innerHTML = insightText;
        },
        
        generateReportInsights: () => {
             app.showNotification("AI Analysis not available in this environment.", "error");
             const insightText = `
                <h5 class="text-base font-semibold text-slate-800">Manual Summary (Based on Raw Data)</h5>
                <p><strong>Checklist Score:</strong> ${state.scores.checklist}/${checklistQuestions.length} behavioral signs observed.</p>
                <p><strong>Highest Scores:</strong> Magnitude (${state.scores.magnitude}%), Neon Runner (High Score: ${state.scores.neonRunner}).</p>
                <p><strong>Areas to Focus On:</strong> The radar chart visualizes key weaknesses. Any module score below 50% suggests a high need for targeted practice in that specific area (e.g., Fact Retrieval or Sequencing).</p>
                <p class="text-purple-700 font-medium mt-3">To get a real, personalized AI analysis, please run this application in a supported environment where the Gemini API can be utilized.</p>
            `;
            document.getElementById('report-insights').innerHTML = insightText;
        }

    };

    document.getElementById('sidebar-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('-translate-x-full'));
    app.init();
</script>
</body>
</html>